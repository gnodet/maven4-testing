name: Maven 4 Compatibility Testing

on:
  workflow_dispatch:
    inputs:
      maven_version:
        description: 'Maven 4 version to test'
        required: true
        default: '4.0.0-rc-1'
      chunk_number:
        description: 'Chunk number to test (or ALL for all chunks)'
        required: true
        default: 'ALL'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Load chunk configuration
        id: set-matrix
        run: |
          if [[ "${{ github.event.inputs.chunk_number }}" == "ALL" ]]; then
            echo "matrix=$(jq -c . maven4-chunks/summary.json)" >> $GITHUB_OUTPUT
          else
            echo "matrix=$(jq -c . "maven4-chunks/chunk-${{ github.event.inputs.chunk_number }}.json")" >> $GITHUB_OUTPUT
          fi

  test-maven4:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix: ${{fromJson(needs.prepare.outputs.matrix)}}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: apache/${{ matrix.repository }}
          
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download and Install Maven 4
        run: |
          mkdir -p ~/.m2
          wget https://archive.apache.org/dist/maven/maven-4/${{ github.event.inputs.maven_version }}/binaries/apache-maven-${{ github.event.inputs.maven_version }}-bin.tar.gz \
            || wget https://dlcdn.apache.org/maven/maven-4/${{ github.event.inputs.maven_version }}/binaries/apache-maven-${{ github.event.inputs.maven_version }}-bin.tar.gz
          tar xzf apache-maven-${{ github.event.inputs.maven_version }}-bin.tar.gz
          echo "M2_HOME=$GITHUB_WORKSPACE/apache-maven-${{ github.event.inputs.maven_version }}" >> $GITHUB_ENV
          echo "$GITHUB_WORKSPACE/apache-maven-${{ github.event.inputs.maven_version }}/bin" >> $GITHUB_PATH
          # Create minimal settings.xml to avoid snapshot resolution
          echo '<settings><profiles><profile><id>no-snapshots</id><repositories><repository><id>central</id><url>https://repo.maven.apache.org/maven2</url><snapshots><enabled>false</enabled></snapshots></repository></repositories></profile></profiles><activeProfiles><activeProfile>no-snapshots</activeProfile></activeProfiles></settings>' > ~/.m2/settings.xml

      - name: Build with Maven 4
        id: build
        continue-on-error: true
        run: |
          mvn -V -B clean package -DskipTests
          echo "build_exit_code=$?" >> $GITHUB_OUTPUT
          mvn -version > maven_version.txt
          echo "BUILD_LOG<<EOF" >> $GITHUB_ENV
          cat maven_version.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Report Results
        uses: actions/github-script@v7
        with:
          script: |
            const buildSuccess = ${{ steps.build.outputs.build_exit_code }} === 0;
            const status = buildSuccess ? '✅ Success' : '❌ Failed';
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Maven 4 Test Results: ${{ matrix.repository }} (${{ github.event.inputs.maven_version }})`,
              body: `
                # Maven 4 Compatibility Test Report
                
                - **Repository**: ${{ matrix.repository }}
                - **Status**: ${status}
                - **Maven Version**: ${{ github.event.inputs.maven_version }}
                - **Test Date**: ${new Date().toISOString()}
                - **Chunk**: ${{ github.event.inputs.chunk_number }}
                
                <details>
                <summary>Maven Version Info</summary>
                
                \`\`\`
                ${process.env.BUILD_LOG}
                \`\`\`
                </details>
              `,
              labels: ['maven4-testing', buildSuccess ? 'success' : 'failed']
            });